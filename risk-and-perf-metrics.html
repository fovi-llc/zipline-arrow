
<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Metrics &#8212; Zipline 3.0 docs</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'risk-and-perf-metrics';</script>
    <link rel="icon" href="_static/zipline.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Development" href="development-guidelines.html" />
    <link rel="prev" title="Calendars" href="trading-calendars.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    <p class="title logo__title">Zipline 3.0 docs</p>
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="install.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="beginner-tutorial.html">
                        Tutorial
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="bundles.html">
                        Data
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="trading-calendars.html">
                        Calendars
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="#">
                        Metrics
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="development-guidelines.html">
                        Development
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="api-reference.html">
                        API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="releases.html">
                        Releases
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://ml4trading.io">
                    ML for Trading
                  </a>
                </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://exchange.ml4trading.io">
                    Community
                  </a>
                </li>
                
                </div>
            </div>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/stefan-jansen/zipline-reloaded" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/ml4trading" title="Twitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="install.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="beginner-tutorial.html">
                        Tutorial
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="bundles.html">
                        Data
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="trading-calendars.html">
                        Calendars
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="#">
                        Metrics
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="development-guidelines.html">
                        Development
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="api-reference.html">
                        API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="releases.html">
                        Releases
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://ml4trading.io">
                    ML for Trading
                  </a>
                </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://exchange.ml4trading.io">
                    Community
                  </a>
                </li>
                
                </div>
            </div>
            
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/stefan-jansen/zipline-reloaded" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/ml4trading" title="Twitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Metrics</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="metrics">
<span id="id1"></span><h1>Metrics<a class="headerlink" href="#metrics" title="Permalink to this heading">#</a></h1>
<p>The risk and performance metrics are summarizing values calculated by Zipline
when running a simulation. These metrics can be about the performance of an
algorithm, like returns or cash flow, or the riskiness of an algorithm, like
volatility or beta. Metrics may be reported minutely, daily, or once at the end
of a simulation. A single metric may choose to report at multiple time-scales
where appropriate.</p>
<section id="metrics-sets">
<h2>Metrics Sets<a class="headerlink" href="#metrics-sets" title="Permalink to this heading">#</a></h2>
<p>Zipline groups risk and performance metrics into collections called “metrics
sets”. A single metrics set defines all of the metrics to track during a single
backtest. A metrics set may contain metrics that report at different time
scales. The default metrics set will compute a host of metrics, such as
algorithm returns, volatility, Sharpe ratio, and beta.</p>
</section>
<section id="selecting-the-metrics-set">
<h2>Selecting the Metrics Set<a class="headerlink" href="#selecting-the-metrics-set" title="Permalink to this heading">#</a></h2>
<p>When running a simulation, the user may select the metrics set to report. How
you select the metrics set depends on the interface being used to run the
algorithm.</p>
<section id="command-line-and-ipython-magic">
<h3>Command Line and IPython Magic<a class="headerlink" href="#command-line-and-ipython-magic" title="Permalink to this heading">#</a></h3>
<p>When running with the command line or IPython magic interfaces, the metrics set
may be selected by passing the <code class="docutils literal notranslate"><span class="pre">--metrics-set</span></code> argument. For example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>zipline<span class="w"> </span>run<span class="w"> </span>algorithm.py<span class="w"> </span>-s<span class="w"> </span><span class="m">2014</span>-01-01<span class="w"> </span>-e<span class="w"> </span><span class="m">2014</span>-02-01<span class="w"> </span>--metrics-set<span class="w"> </span>my-metrics-set
</pre></div>
</div>
</section>
<section id="run-algorithm">
<h3><code class="docutils literal notranslate"><span class="pre">run_algorithm</span></code><a class="headerlink" href="#run-algorithm" title="Permalink to this heading">#</a></h3>
<p>When running through the <a class="reference internal" href="api-reference.html#zipline.run_algorithm" title="zipline.run_algorithm"><code class="xref py py-func docutils literal notranslate"><span class="pre">run_algorithm()</span></code></a> interface, the metrics
set may be passed with the <code class="docutils literal notranslate"><span class="pre">metrics_set</span></code> argument. This may either be the name
of a registered metrics set, or a set of metric object. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">run_algorithm</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">metrics_set</span><span class="o">=</span><span class="s1">&#39;my-metrics-set&#39;</span><span class="p">)</span>
<span class="n">run_algorithm</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">metrics_set</span><span class="o">=</span><span class="p">{</span><span class="n">MyMetric</span><span class="p">(),</span> <span class="n">MyOtherMetric</span><span class="p">(),</span> <span class="o">...</span><span class="p">})</span>
</pre></div>
</div>
</section>
</section>
<section id="running-without-metrics">
<h2>Running Without Metrics<a class="headerlink" href="#running-without-metrics" title="Permalink to this heading">#</a></h2>
<p>Computing risk and performance metrics is not free, and contributes to the total
runtime of a backtest. When actively developing an algorithm, it is often
helpful to skip these computations to speed up the debugging cycle. To disable
the calculation and reporting of all metrics, users may select the built-in
metrics set <code class="docutils literal notranslate"><span class="pre">none</span></code>. For example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>zipline<span class="w"> </span>run<span class="w"> </span>algorithm.py<span class="w"> </span>-s<span class="w"> </span><span class="m">2014</span>-01-01<span class="w"> </span>-e<span class="w"> </span><span class="m">2014</span>-02-01<span class="w"> </span>--metrics-set<span class="w"> </span>none
</pre></div>
</div>
</section>
<section id="defining-new-metrics">
<h2>Defining New Metrics<a class="headerlink" href="#defining-new-metrics" title="Permalink to this heading">#</a></h2>
<p>A metric is any object that implements some subset of the following methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">start_of_simulation</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">end_of_simulation</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">start_of_session</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">end_of_session</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">end_of_bar</span></code></p></li>
</ul>
<p>These functions will be called at the time indicated by their name, at which
point the metric object may collect any needed information and optionally report
a computed value. If a metric does not need to do any processing at one of these
times, it may omit a definition for the given method.</p>
<p>A metric should be reusable, meaning that a single instance of a metric class
should be able to be used across multiple backtests. Metrics do not need to
support multiple simulations at once, meaning that internal caches and data are
consistent between <code class="docutils literal notranslate"><span class="pre">start_of_simulation</span></code> and <code class="docutils literal notranslate"><span class="pre">end_of_simulation</span></code>.</p>
<section id="start-of-simulation">
<h3><code class="docutils literal notranslate"><span class="pre">start_of_simulation</span></code><a class="headerlink" href="#start-of-simulation" title="Permalink to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">start_of_simulation</span></code> method should be thought of as a per-simulation
constructor. This method should initialize any caches needed for the duration of
a single simulation.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">start_of_simulation</span></code> method should have the following signature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">start_of_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">ledger</span><span class="p">,</span>
                        <span class="n">emission_rate</span><span class="p">,</span>
                        <span class="n">trading_calendar</span><span class="p">,</span>
                        <span class="n">sessions</span><span class="p">,</span>
                        <span class="n">benchmark_source</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ledger</span></code> is an instance of <a class="reference internal" href="api-reference.html#zipline.finance.ledger.Ledger" title="zipline.finance.ledger.Ledger"><code class="xref py py-class docutils literal notranslate"><span class="pre">Ledger</span></code></a> which is
maintaining the simulation’s state. This may be used to lookup the algorithm’s
starting portfolio values.</p>
<p><code class="docutils literal notranslate"><span class="pre">emission_rate</span></code> is a string representing the smallest frequency at which
metrics should be reported. <code class="docutils literal notranslate"><span class="pre">emission_rate</span></code> will be either <code class="docutils literal notranslate"><span class="pre">minute</span></code> or
<code class="docutils literal notranslate"><span class="pre">daily</span></code>. When <code class="docutils literal notranslate"><span class="pre">emission_rate</span></code> is <code class="docutils literal notranslate"><span class="pre">daily</span></code>, <code class="docutils literal notranslate"><span class="pre">end_of_bar</span></code> will not be
called at all.</p>
<p><code class="docutils literal notranslate"><span class="pre">trading_calendar</span></code> is an instance of
<code class="xref py py-class docutils literal notranslate"><span class="pre">TradingCalendar</span></code> which is the trading calendar
being used by the simulation.</p>
<p><code class="docutils literal notranslate"><span class="pre">sessions</span></code> is a <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DatetimeIndex.html#pandas.DatetimeIndex" title="(in pandas v2.0.3)"><code class="xref py py-class docutils literal notranslate"><span class="pre">pandas.DatetimeIndex</span></code></a> which is holds the session
labels, in sorted order, that the simulation will execute.</p>
<p><code class="docutils literal notranslate"><span class="pre">benchmark_source</span></code> is an instance of
<a class="reference internal" href="api-reference.html#zipline.sources.benchmark_source.BenchmarkSource" title="zipline.sources.benchmark_source.BenchmarkSource"><code class="xref py py-class docutils literal notranslate"><span class="pre">BenchmarkSource</span></code></a> which is the
interface to the returns of the benchmark specified by
<a class="reference internal" href="api-reference.html#zipline.api.set_benchmark" title="zipline.api.set_benchmark"><code class="xref py py-func docutils literal notranslate"><span class="pre">set_benchmark()</span></code></a>.</p>
</section>
<section id="end-of-simulation">
<h3><code class="docutils literal notranslate"><span class="pre">end_of_simulation</span></code><a class="headerlink" href="#end-of-simulation" title="Permalink to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">end_of_simulation</span></code> method should have the following signature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">end_of_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">packet</span><span class="p">,</span>
                      <span class="n">ledger</span><span class="p">,</span>
                      <span class="n">trading_calendar</span><span class="p">,</span>
                      <span class="n">sessions</span><span class="p">,</span>
                      <span class="n">data_portal</span><span class="p">,</span>
                      <span class="n">benchmark_source</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ledger</span></code> is an instance of <a class="reference internal" href="api-reference.html#zipline.finance.ledger.Ledger" title="zipline.finance.ledger.Ledger"><code class="xref py py-class docutils literal notranslate"><span class="pre">Ledger</span></code></a> which is
maintaining the simulation’s state. This may be used to lookup the algorithm’s
final portfolio values.</p>
<p><code class="docutils literal notranslate"><span class="pre">packet</span></code> is a dictionary to write the end of simulation values for the given
metric into.</p>
<p><code class="docutils literal notranslate"><span class="pre">trading_calendar</span></code> is an instance of
<code class="xref py py-class docutils literal notranslate"><span class="pre">TradingCalendar</span></code> which is the trading calendar
being used by the simulation.</p>
<p><code class="docutils literal notranslate"><span class="pre">sessions</span></code> is a <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DatetimeIndex.html#pandas.DatetimeIndex" title="(in pandas v2.0.3)"><code class="xref py py-class docutils literal notranslate"><span class="pre">pandas.DatetimeIndex</span></code></a> which is holds the session
labels, in sorted order, that the simulation has executed.</p>
<p><code class="docutils literal notranslate"><span class="pre">data_portal</span></code> is an instance of <a class="reference internal" href="api-reference.html#zipline.data.data_portal.DataPortal" title="zipline.data.data_portal.DataPortal"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataPortal</span></code></a>
which is the metric’s interface to pricing data.</p>
<p><code class="docutils literal notranslate"><span class="pre">benchmark_source</span></code> is an instance of
<a class="reference internal" href="api-reference.html#zipline.sources.benchmark_source.BenchmarkSource" title="zipline.sources.benchmark_source.BenchmarkSource"><code class="xref py py-class docutils literal notranslate"><span class="pre">BenchmarkSource</span></code></a> which is the
interface to the returns of the benchmark specified by
<a class="reference internal" href="api-reference.html#zipline.api.set_benchmark" title="zipline.api.set_benchmark"><code class="xref py py-func docutils literal notranslate"><span class="pre">set_benchmark()</span></code></a>.</p>
</section>
<section id="start-of-session">
<h3><code class="docutils literal notranslate"><span class="pre">start_of_session</span></code><a class="headerlink" href="#start-of-session" title="Permalink to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">start_of_session</span></code> method may see a slightly different view of the
<code class="docutils literal notranslate"><span class="pre">ledger</span></code> or <code class="docutils literal notranslate"><span class="pre">data_portal</span></code> than the previous <code class="docutils literal notranslate"><span class="pre">end_of_session</span></code> if the price
of any futures owned move between trading sessions or if a capital change
occurs.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">start_of_session</span></code> method should have the following signature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">start_of_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">ledger</span><span class="p">,</span>
                     <span class="n">session_label</span><span class="p">,</span>
                     <span class="n">data_portal</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ledger</span></code> is an instance of <a class="reference internal" href="api-reference.html#zipline.finance.ledger.Ledger" title="zipline.finance.ledger.Ledger"><code class="xref py py-class docutils literal notranslate"><span class="pre">Ledger</span></code></a> which is
maintaining the simulation’s state. This may be used to lookup the algorithm’s
current portfolio values.</p>
<p><code class="docutils literal notranslate"><span class="pre">session_label</span></code> is a <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Timestamp.html#pandas.Timestamp" title="(in pandas v2.0.3)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Timestamp</span></code></a> which is the label of the
session which is about to run.</p>
<p><code class="docutils literal notranslate"><span class="pre">data_portal</span></code> is an instance of <a class="reference internal" href="api-reference.html#zipline.data.data_portal.DataPortal" title="zipline.data.data_portal.DataPortal"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataPortal</span></code></a>
which is the metric’s interface to pricing data.</p>
</section>
<section id="end-of-session">
<h3><code class="docutils literal notranslate"><span class="pre">end_of_session</span></code><a class="headerlink" href="#end-of-session" title="Permalink to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">end_of_session</span></code> method should have the following signature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">end_of_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">packet</span><span class="p">,</span>
                   <span class="n">ledger</span><span class="p">,</span>
                   <span class="n">session_label</span><span class="p">,</span>
                   <span class="n">session_ix</span><span class="p">,</span>
                   <span class="n">data_portal</span><span class="p">):</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">packet</span></code> is a dictionary to write the end of session values. This dictionary
contains two sub-dictionaries: <code class="docutils literal notranslate"><span class="pre">daily_perf</span></code> and <code class="docutils literal notranslate"><span class="pre">cumulative_perf</span></code>. When
applicable, the <code class="docutils literal notranslate"><span class="pre">daily_perf</span></code> should hold the current day’s value, and
<code class="docutils literal notranslate"><span class="pre">cumulative_perf</span></code> should hold a cumulative value for the entire simulation up
to the current time.</p>
<p><code class="docutils literal notranslate"><span class="pre">ledger</span></code> is an instance of <a class="reference internal" href="api-reference.html#zipline.finance.ledger.Ledger" title="zipline.finance.ledger.Ledger"><code class="xref py py-class docutils literal notranslate"><span class="pre">Ledger</span></code></a> which is
maintaining the simulation’s state. This may be used to lookup the algorithm’s
current portfolio values.</p>
<p><code class="docutils literal notranslate"><span class="pre">session_label</span></code> is a <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Timestamp.html#pandas.Timestamp" title="(in pandas v2.0.3)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Timestamp</span></code></a> which is the label of the
session which is has just completed.</p>
<p><code class="docutils literal notranslate"><span class="pre">session_ix</span></code> is an <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.11)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a> which is the index of the current trading
session being run. This is provided to allow for efficient access to the daily
returns through <code class="docutils literal notranslate"><span class="pre">ledger.daily_returns_array[:session_ix</span> <span class="pre">+</span> <span class="pre">1]</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">data_portal</span></code> is an instance of <a class="reference internal" href="api-reference.html#zipline.data.data_portal.DataPortal" title="zipline.data.data_portal.DataPortal"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataPortal</span></code></a>
which is the metric’s interface to pricing data</p>
</section>
<section id="end-of-bar">
<h3><code class="docutils literal notranslate"><span class="pre">end_of_bar</span></code><a class="headerlink" href="#end-of-bar" title="Permalink to this heading">#</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">end_of_bar</span></code> is only called when <code class="docutils literal notranslate"><span class="pre">emission_mode</span></code> is <code class="docutils literal notranslate"><span class="pre">minute</span></code>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">end_of_bar</span></code> method should have the following signature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">end_of_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">packet</span><span class="p">,</span>
               <span class="n">ledger</span><span class="p">,</span>
               <span class="n">dt</span><span class="p">,</span>
               <span class="n">session_ix</span><span class="p">,</span>
               <span class="n">data_portal</span><span class="p">):</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">packet</span></code> is a dictionary to write the end of session values. This dictionary
contains two sub-dictionaries: <code class="docutils literal notranslate"><span class="pre">minute_perf</span></code> and <code class="docutils literal notranslate"><span class="pre">cumulative_perf</span></code>. When
applicable, the <code class="docutils literal notranslate"><span class="pre">minute_perf</span></code> should hold the current partial day’s value, and
<code class="docutils literal notranslate"><span class="pre">cumulative_perf</span></code> should hold a cumulative value for the entire simulation up
to the current time.</p>
<p><code class="docutils literal notranslate"><span class="pre">ledger</span></code> is an instance of <a class="reference internal" href="api-reference.html#zipline.finance.ledger.Ledger" title="zipline.finance.ledger.Ledger"><code class="xref py py-class docutils literal notranslate"><span class="pre">Ledger</span></code></a> which is
maintaining the simulation’s state. This may be used to lookup the algorithm’s
current portfolio values.</p>
<p><code class="docutils literal notranslate"><span class="pre">dt</span></code> is a <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Timestamp.html#pandas.Timestamp" title="(in pandas v2.0.3)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Timestamp</span></code></a> which is the label of bar that has just
completed.</p>
<p><code class="docutils literal notranslate"><span class="pre">session_ix</span></code> is an <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.11)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a> which is the index of the current trading
session being run. This is provided to allow for efficient access to the daily
returns through <code class="docutils literal notranslate"><span class="pre">ledger.daily_returns_array[:session_ix</span> <span class="pre">+</span> <span class="pre">1]</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">data_portal</span></code> is an instance of <a class="reference internal" href="api-reference.html#zipline.data.data_portal.DataPortal" title="zipline.data.data_portal.DataPortal"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataPortal</span></code></a>
which is the metric’s interface to pricing data.</p>
</section>
</section>
<section id="defining-new-metrics-sets">
<h2>Defining New Metrics Sets<a class="headerlink" href="#defining-new-metrics-sets" title="Permalink to this heading">#</a></h2>
<p>Users may use <a class="reference internal" href="api-reference.html#zipline.finance.metrics.register" title="zipline.finance.metrics.register"><code class="xref py py-func docutils literal notranslate"><span class="pre">zipline.finance.metrics.register()</span></code></a> to register a new metrics
set. This may be used to decorate a function taking no arguments which returns a
new set of metric object instances. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">zipline.finance</span> <span class="kn">import</span> <span class="n">metrics</span>

<span class="nd">@metrics</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;my-metrics-set&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_metrics_set</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">MyMetric</span><span class="p">(),</span> <span class="n">MyOtherMetric</span><span class="p">(),</span> <span class="o">...</span><span class="p">}</span>
</pre></div>
</div>
<p>This may be embedded in the user’s <code class="docutils literal notranslate"><span class="pre">extension.py</span></code>.</p>
<p>The reason that a metrics set is defined as a function which produces a set,
instead of just a set, is that users may want to fetch external data or
resources to construct their metrics. By putting this behind a callable, users
do not need to fetch the resources when the metrics set is not being used.</p>
</section>
</section>


                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="trading-calendars.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Calendars</p>
      </div>
    </a>
    <a class="right-next"
       href="development-guidelines.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Development</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#metrics-sets">Metrics Sets</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-the-metrics-set">Selecting the Metrics Set</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#command-line-and-ipython-magic">Command Line and IPython Magic</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-algorithm"><code class="docutils literal notranslate"><span class="pre">run_algorithm</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-without-metrics">Running Without Metrics</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-new-metrics">Defining New Metrics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#start-of-simulation"><code class="docutils literal notranslate"><span class="pre">start_of_simulation</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-simulation"><code class="docutils literal notranslate"><span class="pre">end_of_simulation</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#start-of-session"><code class="docutils literal notranslate"><span class="pre">start_of_session</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-session"><code class="docutils literal notranslate"><span class="pre">end_of_session</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-bar"><code class="docutils literal notranslate"><span class="pre">end_of_bar</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-new-metrics-sets">Defining New Metrics Sets</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div class="tocsection sourcelink">
    <a href="_sources/risk-and-perf-metrics.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2020, Quantopian Inc..
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.0.1.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>